<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>UX-Interview (RU)</title>
  <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.4/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="min-h-screen flex items-center justify-center bg-neutral-50">
  <!--
    Версия для России с использованием Cloudflare прокси
    Основное отличие - атрибут api-base-url="/api/convai"
  -->
  <elevenlabs-convai 
    id="widget" 
    agent-id="agent_01jxv44dq3f09afkz7n7m7mxac"
    api-base-url="/api/convai"
    inference-api-base-url="/api/convai">
  </elevenlabs-convai>

  <script>
    // Ждем загрузки виджета и переопределяем его настройки
    function setupWidget() {
      const widget = document.getElementById('widget');
      
      if (!widget || !widget.shadowRoot) {
        // Виджет еще не готов, пробуем снова через 100ms
        setTimeout(setupWidget, 100);
        return;
      }
      
      // Принудительно устанавливаем базовые URL через все возможные способы
      widget.apiBaseUrl = '/api/convai';
      widget.inferenceApiBaseUrl = '/api/convai';
      widget.setAttribute('api-base-url', '/api/convai');
      widget.setAttribute('inference-api-base-url', '/api/convai');
      
      // Пытаемся переопределить внутренние настройки виджета
      if (widget._config) {
        widget._config.apiBaseUrl = '/api/convai';
        widget._config.inferenceApiBaseUrl = '/api/convai';
      }
      
      // Если у виджета есть метод для обновления конфигурации
      if (widget.updateConfig) {
        widget.updateConfig({
          apiBaseUrl: '/api/convai',
          inferenceApiBaseUrl: '/api/convai'
        });
      }
      
      // Обработка параметров URL
      const p = new URLSearchParams(window.location.search);
      const agentId = p.get('agent_id');
      if (agentId) {
        widget.setAttribute('agent-id', agentId);
      }
      
      // Собираем dynamic variables
      const dyn = {};
      p.forEach((value, key) => {
        if (key !== 'agent_id') {
          dyn[key] = value;
        }
      });
      widget.setAttribute('dynamic-variables', JSON.stringify(dyn));
    }
    
    // Запускаем настройку виджета
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupWidget);
    } else {
      setupWidget();
    }
    
    // Дополнительно пробуем перехватить и переписать fetch запросы
    const originalFetch = window.fetch;
    window.fetch = function(url, options) {
      // Если URL содержит api.elevenlabs.io или api.us.elevenlabs.io, переписываем его
      if (typeof url === 'string' && (url.includes('api.elevenlabs.io') || url.includes('api.us.elevenlabs.io'))) {
        const urlObj = new URL(url);
        const newUrl = `https://elevenlabs-proxy.shipaleks.workers.dev/api${urlObj.pathname}${urlObj.search}`;
        console.log('Redirecting API call from', url, 'to', newUrl);
        return originalFetch.call(this, newUrl, options);
      }
      return originalFetch.call(this, url, options);
    };
    
    // Перехват WebSocket соединений
    const OriginalWebSocket = window.WebSocket;
    window.WebSocket = function(url, protocols) {
      console.log('WebSocket connection attempt to:', url);
      
      // Если пытаемся подключиться к ElevenLabs API, переписываем URL для прокси
      if (url.includes('api.elevenlabs.io') || url.includes('api.us.elevenlabs.io')) {
        const urlObj = new URL(url);
        const newUrl = `wss://elevenlabs-proxy.shipaleks.workers.dev/api${urlObj.pathname}${urlObj.search}`;
        console.log('Redirecting WebSocket from', url, 'to', newUrl);
        
        // Создаем WebSocket через наш прокси
        return new OriginalWebSocket(newUrl, protocols);
      }
      
      return new OriginalWebSocket(url, protocols);
    };
  </script>
</body>
</html>
