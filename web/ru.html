<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>UX-Interview (RU)</title>
  <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.4/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="min-h-screen flex items-center justify-center bg-neutral-50">
  <!--
    Версия для России с использованием Cloudflare прокси
    Основное отличие - атрибут api-base-url="/api/convai"
  -->
  <elevenlabs-convai 
    id="widget" 
    agent-id="agent_01jxv44dq3f09afkz7n7m7mxac"
    api-base-url="/api"
    inference-api-base-url="/api">
  </elevenlabs-convai>

  <script>
    // Ждем загрузки виджета и переопределяем его настройки
    function setupWidget() {
      const widget = document.getElementById('widget');
      
      if (!widget || !widget.shadowRoot) {
        // Виджет еще не готов, пробуем снова через 100ms
        setTimeout(setupWidget, 100);
        return;
      }
      
      // Принудительно устанавливаем базовые URL через все возможные способы
      widget.apiBaseUrl = '/api';
      widget.inferenceApiBaseUrl = '/api';
      widget.setAttribute('api-base-url', '/api');
      widget.setAttribute('inference-api-base-url', '/api');
      
      // Пытаемся переопределить внутренние настройки виджета
      if (widget._config) {
        widget._config.apiBaseUrl = '/api';
        widget._config.inferenceApiBaseUrl = '/api';
      }
      
      // Если у виджета есть метод для обновления конфигурации
      if (widget.updateConfig) {
        widget.updateConfig({
          apiBaseUrl: '/api',
          inferenceApiBaseUrl: '/api'
        });
      }
      
      // Обработка параметров URL
      const p = new URLSearchParams(window.location.search);
      const agentId = p.get('agent_id');
      if (agentId) {
        widget.setAttribute('agent-id', agentId);
      }
      
      // Собираем dynamic variables
      const dyn = {};
      p.forEach((value, key) => {
        if (key !== 'agent_id') {
          dyn[key] = value;
        }
      });
      widget.setAttribute('dynamic-variables', JSON.stringify(dyn));
    }
    
    // Запускаем настройку виджета
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupWidget);
    } else {
      setupWidget();
    }
    
    // Дополнительно пробуем перехватить и переписать fetch запросы
    const originalFetch = window.fetch;
    window.fetch = function(url, options) {
      // Если URL содержит api.elevenlabs.io или api.us.elevenlabs.io, переписываем его
      if (typeof url === 'string' && (url.includes('api.elevenlabs.io') || url.includes('api.us.elevenlabs.io'))) {
        const urlObj = new URL(url);
        const newUrl = `/api${urlObj.pathname}${urlObj.search}`;
        console.log('Redirecting API call from', url, 'to', newUrl);
        return originalFetch.call(this, newUrl, options);
      }
      return originalFetch.call(this, url, options);
    };
    
    // Перехват WebSocket соединений
    const OriginalWebSocket = window.WebSocket;
    window.WebSocket = function(url, protocols) {
      console.log('WebSocket connection attempt to:', url);
      
      // Если пытаемся подключиться к ElevenLabs API
      if (url.includes('api.elevenlabs.io') || url.includes('api.us.elevenlabs.io')) {
        // Показываем сообщение об ограничении
        const errorMsg = `
          <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                      background: #ff4444; color: white; padding: 20px; border-radius: 10px; 
                      z-index: 9999; text-align: center; max-width: 500px;">
            <h3>Ограничение доступа из России</h3>
            <p>К сожалению, голосовая функция недоступна из России из-за технических ограничений.</p>
            <p>Возможные решения:</p>
            <ul style="text-align: left;">
              <li>Использовать VPN</li>
              <li>Попросить респондента из другой страны</li>
              <li>Дождаться альтернативного решения</li>
            </ul>
            <button onclick="this.parentElement.remove()" 
                    style="margin-top: 10px; padding: 5px 20px; background: white; color: #ff4444; 
                           border: none; border-radius: 5px; cursor: pointer;">
              Закрыть
            </button>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', errorMsg);
        
        // Возвращаем фейковый WebSocket, чтобы не сломать виджет полностью
        return {
          readyState: 3, // CLOSED
          close: () => {},
          send: () => {},
          addEventListener: () => {},
          removeEventListener: () => {}
        };
      }
      
      return new OriginalWebSocket(url, protocols);
    };
  </script>
</body>
</html>
